title: MongoDB 单结点基准测试报告
tags: mongodb
date: 2015-02-04
---

# MongoDB 单结点基准测试报告

## 环境
* 机型： DELL R720
* CPU ： 逻辑CPU 24
* 内存： 32GB
* 硬盘： 300*8 Raid0+1 非 SSD
* 操作系统: CentOS 6.6
* Kernel版本： Linux version 2.6.32-431.el6.x86_64 
* 测试套件：使用YCSB对MongoDB Replica Set进行压力测试

## 多写少读场景（1千万次操作，300线程并发）

### 结论

* 对于 TOKUMX，极限 TPS 在4万左右。系统的瓶颈主要在 CPU 上。
* 对于 MongoDB，尽管官方文档中强烈建议单台机器上最好只跑一个实例，但是测试显示单实例并不足以压榨出系统的全部性能

### TokuMX（2.0版本 使用 directio, cachesize 为26GB）
90%写 10%读

| TPS | 平均延迟时间(us) | 最小延迟时间(us) | 最大延迟时间(us) | 95%情况下的延迟(ms) | 99%情况下的延迟(ms)|type|
| --- | --- | --- |---|---| ---- | --- |
|29873| 612| 11 | 8390894 | 0 | 0| on Write|
|     |  90845 | 183 | 8737456| 267 | 438 | on Read|

CPU 占用
![cpu占用icinga截图](http://i.imgur.com/Fbvg8Mz.jpg)



![CPU占用截图2](http://i.imgur.com/s0NOmUz.jpg)

内存占用
![内存占用icinga截图](http://i.imgur.com/oIh8LMQ.jpg)

磁盘IO
![磁盘io cinga占用截图](http://i.imgur.com/SF8YCOH.jpg)

网络IO
![网络io icinga截图](http://i.imgur.com/JKwcJfV.jpg)

### MongoDB（2.6.5）

| TPS | 平均延迟时间(us) | 最小延迟时间(us) | 最大延迟时间(us) | 95%情况下的延迟(ms) | 99%情况下的延迟(ms)|type|
| --- | --- | --- |---|---| ---- |
|8112| 142| 13 | 1098003 | 0 | 0| on write|
| | 366429 | 152 | 10330816 | 136 | 152| on read|


![cpu占用icinga截图](http://i.imgur.com/7yUu4hb.jpg)



![CPU占用截图2](http://i.imgur.com/XPLAzlO.jpg)

内存占用
![内存占用icinga截图](http://i.imgur.com/bcbfoDA.jpg)

磁盘IO
![磁盘io cinga占用截图](http://i.imgur.com/qdiu8l1.jpg)

网络IO
![网络io icinga截图](http://i.imgur.com/nKQISo8.jpg)

### 分析
* 最大 TPS 时，TokuMX 的主要性能瓶颈为 CPU，而非磁盘 IO。TokuMX 对于文件存储以及 journey 文件存储进行了一系列优化。包括使用较大的缓存，directio 直接进行文件读写而不使用系统调用。但是，TokuMX 会在内存中对数据进行压缩，进行压缩存储，多写少读时猜测 CPU 主要消耗于此。
* 最大 TPS 时，MongoDB 的 CPU 与 IO 使用都不算高，应该为本身存储机制的原因。相较于 TokuMX，它在多写少读场景时，确实性能相差很大。TokuMX 无论在 TPS、延时等指标上，均优于 MongoDB。

## 多读少写场景（500万次操作，200线程并发）

### 结论
* 尽管 DB 数据容量大于内存容量，但是测试数据显示，MongoDB 与 TokuMX 的读性能都很优异。ToKu的 TPS 指标约为 MongoDB 的一倍左右。
* 请求分布使用`Zipfian`模式 [^1]

### TokuMX（2.0版本，使用 directio，cachesize 为26GB）

| TPS | 平均延迟时间(us) | 最小延迟时间(us) | 最大延迟时间(us) | 95%情况下的延迟(ms) | 99%情况下的延迟(ms)|
| --- | --- | --- |---|---| ---- |
|80313| 4220| 200 | 981519 | 11 | 16|

### MongoDB (2.6.5)

| TPS | 平均延迟时间(us) | 最小延迟时间(us) | 最大延迟时间(us) | 95%情况下的延迟(ms) | 99%情况下的延迟(ms)|
| --- | --- | --- |---|---| ---- |
|8112| 51568 | 166 | 637938 | 139 | 211 |


## 总结
无论读写，在standalone模式上，相比MongoDB, ToKuMX都表现更加优秀的性能表现。目前拟在开发环境上以standalone模式部署TokuMX结点。同时，在内容服务器上做一至二周的TokuMX Replica set / Sharding 长期稳定性测试，未来拟将TokuMX应用在测试与生产环境部署。


## 原始数据

### TokuMX

| 操作数 |	线程数 | TPS| 平均时延(us) |	最小时延(us) | 最大时延(us) | 95%时延(ms) |	99%时延(ms) | type |
|--- | --- | --- | --- | --- | ---| --- | ---|---|
| 1千万 | 80 | 29321	| 2709 |	10	| 33148174 |	18 |	38	 | 多写少读 |
| 1千万 |	500 | 	34452 |	13816|	11|	25745359|	113|	222|	多写少读|
|1千万|	500|	32475	|14858|	11	|28567847|	106	|231|	多写少读|
|1千万	|300	|38881|	7462|	10|	30358763|	66|	136|	多写少读|
|5百万|	200|	80313	|4220|	200|	981519|	11|	16|	多读少写|
|5百万|	200|	79762|	4039|	200|	205199|	11|	16|	多读少写|
|5百万|	300|	59342|	8157|	184	|1317689|	22|	30|	多读少写|
|5百万|	500|	46653|	10746|	246|	502574|	29|	42|	多读少写|


### MongoDB

| 操作数 |	线程数 | TPS| 平均时延(us) |	最小时延(us) | 最大时延(us) | 95%时延(ms) |	99%时延(ms) | type |
|--- | --- | --- | --- | --- | ---| --- | ---| --- |
|2千万	|80|	5524	|14434|	12|	10856037|	148|	224|	多写少读|
|2千万|	80|	5749|	5749|	10|	6684541|	144	|207|	多写少读|
|1千万|	300|	7040|	42356|	11|	7432462|	519|	707|	多写少读|
|3百万|	80|	35655|	15527	|156|	193931|	41	|64|	多读少写|
|5百万|	200|	33243|	51568|	166|	637938|	139|	211|	多读少写|




---

[^1]: Zipfan模式：请求类似正态分布模型，某些数据会被多次请求，某些数据则会很少被请求覆盖。
