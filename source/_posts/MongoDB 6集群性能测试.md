title: MongoDB 6节点集群性能测试
date: 2015-02-09
tags: mongodb
---

# MongoDB 6节点集群性能测试

标签（空格分隔）： MongoDB benchmark

---

## 环境
* 服务器： DELL R720
* CPU： 24核
* 内存： 32GB
* 硬盘： 300GB*8 Raid10


## Sharding 集群部署
3 sharding， 每个片由一个2结点的Replica Set组成。每个Mongod进程独立部署于一台机器上。剩余的三台分别部署了三个Config Server, 一个仲裁服务，一个mongos服务。

![部署图](http://i.imgur.com/M6j4DZe.png)

## Load

* TPS: 6537 (Mongo2.6.7)

| 平均延时(us) | 最小延时(us) | 最大延时(us) | 95%下的延时(ms) | 99%下的延时(ms)|
| --- | --- | --- |---|---| ---- | 
| 30356 | 11 | 7792447 | 0 | 0 |

* TPS: 7726 (Mongo2.6.7)

| 平均延时(us) | 最小延时(us) | 最大延时(us) | 95%下的延时(ms) | 99%下的延时(ms)|
| --- | --- | --- |---|---| ---- | 
| 25721 | 12 | 6809346 | 244 | 473 |


* TPS: 4847 (Mongo3.0 rc7)

| 平均延时(us) | 最小延时(us) | 最大延时(us) | 95%下的延时(ms) | 99%下的延时(ms)|
| --- | --- | --- |---|---| ---- | 
| 40247 | 12 | 227267879 | 463 | 594 |

* TPS: 17841 (TokuMx 2.0)

| 平均延时(us) | 最小延时(us) | 最大延时(us) | 95%下的延时(ms) | 99%下的延时(ms)|
| --- | --- | --- |---|---| ---- | 
| 11133 | 11 | 72062170 | 0 | 237 |



## 1千万次读写（90%读10%写）

* TPS: 37617 (Mongo2.6.7)

| 平均延时(us) | 最小延时(us) | 最大延时(us) | 95%下的延时(ms) | 99%下的延时(ms)| 类型 |
| --- | --- | --- |---|---| ---- | --- | 
| 39795 | 291 | 1778428 | 161 | 278 | update |


| 平均延时(us) | 最小延时(us) | 最大延时(us) | 95%下的延时(ms) | 99%下的延时(ms)| 类型 |
| --- | --- | --- |---|---| ---- | --- | 
| 1302 | 340 | 1303174 | 2 | 4 | read |


* TPS: 46681  (Mongo2.6.7)

| 平均延时(us) | 最小延时(us) | 最大延时(us) | 95%下的延时(ms) | 99%下的延时(ms)| 类型 |
| --- | --- | --- |---|---| ---- | --- |
| 8010 | 807 | 1460450 | 8 | 63 | UPDATE |
| 3778 | 415 | 351219 | 5 | 7 | READ |


* TPS: 47615 (Mongo2.6.7)

| 平均延时(us) | 最小延时(us) | 最大延时(us) | 95%下的延时(ms) | 99%下的延时(ms)| 类型 |
| --- | --- | --- |---|---| ---- | --- |
| 6895 | 748 | 1231740 | 8 | 32 | UPDATE |
| 3764 | 375 | 1286127 | 5 | 7 | READ |


* TPS: 37261 (Mongo3.0 rc7)

| 平均延时(us) | 最小延时(us) | 最大延时(us) | 95%下的延时(ms) | 99%下的延时(ms)| 类型 |
| --- | --- | --- |---|---| ---- | --- |
| 7312 | 646 | 1232747 | 10 | 13 | UPDATE |
| 5103 | 405 | 1207027 | 8 | 11 | READ |

* TPS: 29556 (Mongo3.0 rc7)

| 平均延时(us) | 最小延时(us) | 最大延时(us) | 95%下的延时(ms) | 99%下的延时(ms)| 类型 |
| --- | --- | --- |---|---| ---- | --- |
| 12180 | 622 | 38704912 | 13 | 35 | UPDATE |
| 5831 | 360 | 1232352 | 9 | 20 | READ |

* TPS: 43550 (TokuMX 2.0)

| 平均延时(us) | 最小延时(us) | 最大延时(us) | 95%下的延时(ms) | 99%下的延时(ms)| 类型 |
| --- | --- | --- |---|---| ---- | --- |
| 9434 | 493 | 3169193 | 7 | 212 | UPDATE | 
| 4039 | 351 | 1458476 | 2 | 14 | READ |


* TPS: 72998 (TokuMX 2.0)

| 平均延时(us) | 最小延时(us) | 最大延时(us) | 95%下的延时(ms) | 99%下的延时(ms)| 类型 |
| --- | --- | --- |---|---| ---- | --- |
| 4280 | 404 | 1427876 | 6 | 9 | UPDATE |
| 2433 | 327 | 1766519 | 3 | 5 | READ |

## 结果

### 排序

| 序号 | TPS | 说明 |
| :----: | --- | ----: |
| 1 | 72998 | TokuMX -- 这测试是在TokuMX做完balanc后执行，此时各分片之间数据平衡，效率最高 |
| 2 | 47615  | MongoDB 3.0 RC7 |
| 3 | 46681 | MongoDB 2.6.7 |
| 4 | 43550 | TokuMX - 此时Toku仍然在做Balacing操作|
| 5 | 37617 | Mongo2.6.7 | 
| 6 | 37261 | TokuMX 2.0 - 此时Toku仍然在做Balacing操作| 
| 7 | 29556 | TokuMX 3.0 rc7 |


### TokuMX

TokuMX的测试性能远远高于标准版本的MongoDB。但是测试过程中，TokuMX的稳定性也是最差的。ToKuMX的在稳定性的不足有：

* 不合时宜的sharding结点平衡: 在sharding压测中，当大量insert时，即时发现结点间的balance超出阈值时，MongoDB并不会立刻进行平衡，而是会等到设置的窗口期间到达时再行同步，即时手工强行触发，也仅会同步少量chunk。TokuMX会在Insert结束后甚至在批量插入时，背景线程就进行balancing，balance本身甚至会造成ycsb运行速度减慢，甚至在数据高峰时出现闪退（直接服务退出，无异常）。

* 臃肿迟缓的Oplog同步: 服务在恢复重启时，oplog即时在两端没数据（所有的DB、Collection均已被 DROP）的情况下，也要进行大量Oplog同步。Mongod进程会在重启后，很长时间处于startup2状态；甚至有两次出现TokuMX在ROLLBACK状态下直接假死掉，需要删除全部数据文件后才能恢复服务。

* TokuMX 守护：尝试使用Daemontools来守护TokuMX进程， 使得在TokuMX在异常退出后自动重启。但是，TokuMX无论是否工作在fork模式，都会出现一些奇怪的现象。如，启动后无法进行服务（defunc），无论正常输出结果至日志或config文件无法被正确读取等。

> 对于TokuMX，建议目前仅使用Standalone模式，暂不在生产系统上进行使用，仅用于开发环境。


### MongoDB 3.0
从测试结果上来看，RC版本的MongoDB3.0版本性能未见较大提高，这可能是仍然处在RC版本的原因。

### YCSB对于Sharding性能测试的影响
YCSB的测试数据生成，对于sharding测试具有一定影响。YCSB的测试数据除主键\_id外，其余的字段均为binData格式。在插入分片时，只能根据主键设置片键。这样，在插入时，往往大量数据涌入至一个Repl，造成各分片之间数据非常不平衡。[^1]

当结点之间数据不平衡时，由于测试采用zipfian分布，因此很容易出现大量查询落在结点中某一个分片的情况，造成集群性能下降。

> 对于大量资源型数据，建议在导入后，立即设置MongoDB Balancer的窗口期[^2]，让MongoDB来进行Collection数据平衡。或者在场景合适的情况下，不对Collection进行分片，而是将各个Collection平衡到不同的结点上。


---
[^1]: MongoDB官方对于使用_id会在大量insert中显著拖慢性能有专门分析，请见[这里](http://docs.mongodb.org/manual/core/sharding-shard-key/)
[^2]: 实现测试中，发现新的MongoDB2.6版本，人工通过`startBalancer()`来触发平衡已经没有明显效果，[官方文档](http://docs.mongodb.org/manual/tutorial/manage-sharded-cluster-balancer/)建议还是通过设置窗口期来控制平衡器。