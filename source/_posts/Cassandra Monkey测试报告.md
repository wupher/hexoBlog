tags: cassandra, 灾难, 测试
date: 2015-03-12
title: Cassandra Monkey测试报告
---

# Cassandra Monkey测试报告

标签（空格分隔）： Cassandra Monkey测试 benchmark

---

## 环境
* 机型： DELL R720
* CPU ： 逻辑CPU 24
* 内存： 32GB
* 硬盘： 3 Disk 300GB For Linux, 300GB for DB file, 300GB for data backup
* 操作系统: CentOS 6.6
* Kernel版本： Linux version 2.6.32-431.el6.x86_64 
* 测试套件：使用YCSB对MongoDB Replica Set进行压测同时释放Monkey来测试服务HA

## 测试
### 1. CPU占用 50%

* 结论：CPU占用50%对于Cassandra性能影响不大
* YCSB: 50线程并发， 1000万次操作 
* TPS： __8858__

| 平均延迟时间(us) | 最小延迟时间(us) | 最大延迟时间(us) | 95%情况下的延迟(ms) | 99%情况下的延迟(ms)| 类型 |
|-----|--------------|--------------|--------------|-------|--------------------|
| 4510 |340|287066| 5 | 5 | UPDATE |
| 5713 | 964 | 304590 | 6 | 6 | READ |

![CPU占用](http://i.imgur.com/EXzrU0a.jpg)



### 2. CPU占用100%

* 结论：CPU占用100%对于Cassandra性能影响不大
* YCSB: 50线程并发， 1000万次操作 
* TPS： __8851__

| 平均延迟时间(us) | 最小延迟时间(us) | 最大延迟时间(us) | 95%情况下的延迟(ms) | 99%情况下的延迟(ms)| 类型 |
|-----|--------------|--------------|--------------|-------|--------------------|
| 4449 | 341 | 1225644 | 5 | 7 | UPDATE | 
| 5734 | 999 | 1226516 | 6 | 8 | READ   |

CPU占用时，OpsCents监控会监测到CPU load过高，显示警告信息。

![OpsCenter报警](http://i.imgur.com/fNq5XMv.jpg)


### 3. 网络延时200ms

* 结论： 网络延时对于Cassandra的影响是__灾难__性的，TPS下降到仅有数百，但是OpsCenter居然显示一切正常。只知道集群慢，为什么慢则完全不知道。
* YCSB： 50线程并发，1000万次操作
* TPS: __690__

由于延时，造成无法生成报告，平均TPS为680~690左右。

OpsCenter的网络监控很难判断异常点
![OpsCenter网络监控](http://i.imgur.com/X5V21J9.png)

机器监控也显示一切正常
![机器监控也显示一切正常](http://i.imgur.com/QiLfztS.png)

### 4. 丢包 50% - 100%

* 结论： 网络丢包对于Cassandra的影响是__灾难__性的，整个YCSB完全无法连接，程序持续抛出异常，服务完全不可用
* YCSB： 50线程并发，1000万次操作
* TPS: __0__

OpsCenter的网络测监控也很难看出端倪，不过，整个系统的Ping都会丢包，ssh连接也会出现缓慢，报错，故障还是能够被发现的。

![net monitor](http://i.imgur.com/baLdRuW.png)

### 5. 异常关闭进程

* 结论： 对于服务器影响有限，Cassandra的非中心化专门应对此种场景，少掉一个结点，性能影响有限
* YCSB： 50线程并发，500万次操作
* TPS ：  __8539__

| 平均延迟时间(us) | 最小延迟时间(us) | 最大延迟时间(us) | 95%情况下的延迟(ms) | 99%情况下的延迟(ms)| 类型 |
|-----|--------------|--------------|--------------|-------|--------------------|
| 3365 | 344 | 1335131 | 4 | 4 | UPDATE | 
| 6036 | 1099 | 1346483 | 7 | 13 | READ   |

对于服务进程异常中断，OpsCenter可以给出报警

![OpsCenter报警](http://i.imgur.com/wwDtgPG.png)

### 6. 磁盘空间占满

* 结论： 等同于服务当机，测试结果与上文类型。另外，Cassandra对于数据文件磁盘异常允许设置多种策略应对。除了常见的stop外，当挂载多个磁盘时，还允许服务使用其它磁盘继续进行服务。对于操作日志磁盘占满，Cassandra默认设置会停止服务。
* YCSB： 50线程并发，500万次操作
* TPS ：  __9731__

| 平均延迟时间(us) | 最小延迟时间(us) | 最大延迟时间(us) | 95%情况下的延迟(ms) | 99%情况下的延迟(ms)| 类型 |
|-----|--------------|--------------|--------------|-------|--------------------|
| 2906 | 390 | 140832 | 3 | 5 | UPDATE | 
| 5574 | 1820 | 218968 | 6 | 10 | READ |

当磁盘空间没有剩余空间时，OpsCenter会显示错误。

![操作异常](http://i.imgur.com/KY3JA6M.png)


### 7. 内存大量占用至50%

* 结论： 当内存占用升到50%以上时，Cassandra运行效率会有所降低，OpsCenter会对结点状态进行监控。当内存占用过高时，会给出结点状态报警。
* YCSB:  50线程并发，50万次操作
* TPS: __6621__

| 平均延迟时间(us) | 最小延迟时间(us) | 最大延迟时间(us) | 95%情况下的延迟(ms) | 99%情况下的延迟(ms)| 类型 |
|-----|--------------|--------------|--------------|-------|--------------------|
| 5289 | 348 | 3076735 | 1 | 205 | UPDATE | 
| 7398 | 855 | 6387045 | 3 | 206 | READ |





